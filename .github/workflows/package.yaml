name: Cross-Platform JavaFX Build (jpackage)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_installers:
    # Use a matrix to run the job on Windows, macOS, and Linux runners
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          # Define the target OS and the corresponding installer extension for artifacts
          - os: windows-latest
            installer_ext: msi
            installer_type: Windows MSI Installer
          - os: macos-latest
            installer_ext: dmg
            installer_type: macOS DMG Installer
          - os: ubuntu-latest
            installer_ext: deb
            installer_type: Linux DEB Installer

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # The setup-java action makes packaging easier by supporting JDKs with JavaFX pre-bundled (like BellSoft Liberica Full JDK).
      - name: Set up JDK 21 with JavaFX
        uses: actions/setup-java@v4
        with:
          distribution: 'liberica' # BellSoft Liberica is a common choice for bundled JavaFX
          java-version: '21'
          java-package: 'jdk+fx' # Request the JDK with JavaFX included
          cache: 'maven'

      # Step specifically needed for Windows to create MSI installers
      - name: Install WiX Toolset (Windows only)
        if: matrix.os == 'windows-latest'
        run: |
          choco install wixtoolset -y
          # Add WiX to path for the jpackage tool
          echo "C:\Program Files\Wix Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      - name: Build and Package with Maven (jpackage)
        run: |
          # On Linux, installing libgtk2.0-0 is required for jpackage to work
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y libgtk2.0-0
          fi
          
          # 'clean package' will compile, create JAR, and then execute the jpackage-maven-plugin goal
          mvn -B clean package --file pom.xml

      - name: Find Generated Installer File
        id: find_file
        run: |
          # Search for the generated installer file in the target/installer directory
          # Adjust the glob pattern if your app name or version is dynamic
          # Assuming app name is 'MyJavaFXApp' and version is 1.0.0
          INSTALLER_PATH=$(find target/installer -name "MyJavaFXApp-*-${{ matrix.installer_ext }}" -print -quit)
          echo "installer_path=$INSTALLER_PATH" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.installer_type }} (${{ matrix.os }})
          path: ${{ steps.find_file.outputs.installer_path }}